<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <title>CLARA_WEB</title>
  <link rel="stylesheet" href="spec.css" />
  <style>
    #cameraContainer {
      position: relative;
      display: inline-block;
    }
    #cameraCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #controls > * {
      margin-right: 10px;
      margin-bottom: 10px;
    }
    #lineYInput {
      width: 60px;
    }
    #generateBtn.active {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
    }
    #generateBtn {
      background-color: #f0f0f0;
      color: #555;
      border: 1px solid #ccc;
      padding: 6px 12px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
  </style>
</head>
<body>
    <nav class="nav">
      <a href="home.html">
        <div class="navlogo">
        <p>CLARA</p>
        </div>
      </a>
     <div class="nav-menu">
       <ul>
         <li><a href="http://127.0.0.1:5000/templates/home.html" class="link">Home</a></li>
         <li><a href="http://127.0.0.1:5050/" class="link">Screen</a></li>
         <li><a href="http://127.0.0.1:5000/templates/eform.html" class="link">Form</a></li>
         <li><a href="http://127.0.0.1:5000/templates/history.html" class="link">History</a></li>
         <li><a href="http://127.0.0.1:5000/templates/chat.html" class="link">ChatBot</a></li>
         <li><a href="#" class="link active">Spectro</a></li>
       </ul>
     </div>
     <a href="!SignIn.html">
       <div class="sn">
         <div class="snb">
           <i class='bx bxs-user'></i>
           <h3>CLARA</h3>
         </div>
       </div>
     </a>
      <div class="dropdown-container">
        <button id="menuToggle" class="menu-btn"><i class='bx bx-menu'></i></button>
        <div id="dropdownMenu" class="dropdown-menu">
          <a href="http://127.0.0.1:5000/templates/tele.html">TeleMed</a>
          <a href="http://127.0.0.1:5000/templates/spec.html">Spectro</a>
          <a href="http://127.0.0.1:5000/templates/info.html">Info</a>
        </div>
      </div>
    </nav>

  <h1>Real-time Spectrometer Viewer</h1>

  <div id="controls">
    <button id="startCameraBtn">Start Camera</button>
    <input type="text" id="nameInput" placeholder="Enter name" />
    <button id="generateBtn" disabled>Graph</button>
    <button id="autoSetBtn" disabled>AutoSet Line Y</button>
    <label for="lineYInput">Line Y:</label>
    <input type="number" id="lineYInput" min="0" max="479" value="240" disabled />
    <button id="exportBtn" disabled>Export Graph</button>
  </div>

  <div id="cameraContainer">
    <video id="camera" autoplay playsinline width="640" height="480"></video>
    <canvas id="cameraCanvas" width="640" height="480"></canvas>
  </div>

  <div id="chart">
    <canvas id="spectrumChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5QNZ34fy2EH3wxqQY38Ny_mH93dIHptQ",
      authDomain: "clara-454e4.firebaseapp.com",
      databaseURL: "https://clara-454e4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "clara-454e4",
      storageBucket: "clara-454e4.firebasestorage.app",
      messagingSenderId: "643727783847",
      appId: "1:643727783847:web:f227136002e6d9af2fe882",
      measurementId: "G-J14TTDQVTH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const PEAKS = [210, 275, 630, 650, 670];

    const spectrumChart = new Chart(document.getElementById("spectrumChart"), {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Absorption (1/mm)",
            data: [],
            borderColor: "orange",
            fill: false,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: "Wavelength (nm)" } },
          y: { 
            title: { display: true, text: "Absorption (1/mm)" }, 
            min: 0, 
            max: 1,
            ticks: { callback: value => value.toFixed(2) }
          }
        }
      }
    });

    function generateData(name, baseData = null) {
      const labels = [];
      const data = [];
      for (let nm = 200; nm <= 700; nm += 5) {
        labels.push(nm);
        let value;
        if (baseData) {
          value = baseData[data.length] + (Math.random() * 0.0005 - 0.00025);
        } else {
          if (PEAKS.includes(nm)) {
            value = Math.random() * 0.3;
          } else {
            value = Math.random() * 0.05;
          }
        }
        data.push(Math.max(0, Math.min(1, value)));
      }
      return { labels, data };
    }

    async function loadOrGenerateGraph(name) {
      const snapshot = await get(child(ref(db), "graphs/" + name));
      let graphData;
      if (snapshot.exists()) {
        const saved = snapshot.val();
        graphData = generateData(name, saved.data);
      } else {
        graphData = generateData(name);
        await set(ref(db, "graphs/" + name), graphData);
      }
      return graphData;
    }

    function checkLineBlackness() {
      if (!cameraRunning) return false;
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = camera.videoWidth;
      tempCanvas.height = camera.videoHeight;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(camera, 0, 0);
      const frame = tempCtx.getImageData(0, scanLineY, camera.videoWidth, 1).data;
      let blackPixels = 0;
      const totalPixels = camera.videoWidth;
      for (let x = 0; x < totalPixels; x++) {
        const i = x * 4;
        const r = frame[i];
        const g = frame[i + 1];
        const b = frame[i + 2];
        const blackness = 1 - (r + g + b) / 765;
        if (blackness >= 0.8) blackPixels++;
      }
      return (blackPixels / totalPixels) >= 0.8;
    }

    let currentName = "";
    let intervalId = null;
    let isGenerating = false;

    const startCameraBtn = document.getElementById("startCameraBtn");
    const generateBtn = document.getElementById("generateBtn");
    const autoSetBtn = document.getElementById("autoSetBtn");
    const nameInput = document.getElementById("nameInput");
    const lineYInput = document.getElementById("lineYInput");
    const exportBtn = document.getElementById("exportBtn");

    startCameraBtn.addEventListener("click", async () => {
      if (!cameraRunning) {
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
          camera.srcObject = cameraStream;
          cameraRunning = true;
          drawCameraOverlay();
          startCameraBtn.textContent = "Stop Camera";
          generateBtn.disabled = false;
          autoSetBtn.disabled = false;
          lineYInput.disabled = false;
          exportBtn.disabled = false;
        } catch (err) {
          console.error("Camera error:", err);
          alert("Cannot access camera");
        }
      } else {
        stopGenerating();
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        cameraRunning = false;
        clearOverlay();
        startCameraBtn.textContent = "Start Camera";
        generateBtn.disabled = true;
        autoSetBtn.disabled = true;
        lineYInput.disabled = true;
        exportBtn.disabled = true;
      }
    });

    function stopGenerating() {
      isGenerating = false;
      generateBtn.classList.remove("active");
      generateBtn.textContent = "Graph";
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      spectrumChart.data.labels = [];
      spectrumChart.data.datasets[0].data = [];
      spectrumChart.update();
    }

    async function startGenerating() {
      currentName = nameInput.value.trim();
      if (!currentName) return;
      isGenerating = true;
      generateBtn.classList.add("active");
      generateBtn.textContent = "Stop Graphing";
      const graph = await loadOrGenerateGraph(currentName);
      spectrumChart.data.labels = graph.labels;
      spectrumChart.data.datasets[0].data = graph.data;
      spectrumChart.update();
      intervalId = setInterval(() => {
        if (!checkLineBlackness()) {
          stopGenerating();
          return;
        }
        spectrumChart.data.datasets[0].data = spectrumChart.data.datasets[0].data.map((v, i) => {
          const nm = spectrumChart.data.labels[i];
          const delta = PEAKS.includes(nm) 
            ? (Math.random() * 0.01 - 0.005)
            : (Math.random() * 0.0025 - 0.00125);
          return Math.max(0, Math.min(1, v + delta));
        });
        spectrumChart.update();
      }, 200);
    }

    generateBtn.addEventListener("click", () => {
      if (!isGenerating) {
        startGenerating();
      } else {
        stopGenerating();
      }
    });

    // Export Graph
    exportBtn.addEventListener("click", () => {
      const name = nameInput.value.trim() || "graph";
      const link = document.createElement("a");
      link.href = spectrumChart.toBase64Image();
      link.download = `${name}.png`;
      link.click();
    });

    const camera = document.getElementById("camera");
    const cameraCanvas = document.getElementById("cameraCanvas");
    const ctxCam = cameraCanvas.getContext("2d");
    let cameraStream = null;
    let cameraRunning = false;
    let scanLineY = parseInt(lineYInput.value);

    function clearOverlay() {
      ctxCam.clearRect(0, 0, cameraCanvas.width, cameraCanvas.height);
    }

    function drawCameraOverlay() {
      if (!cameraRunning) {
        clearOverlay();
        return;
      }
      ctxCam.clearRect(0, 0, cameraCanvas.width, cameraCanvas.height);
      ctxCam.strokeStyle = "yellow";
      ctxCam.lineWidth = 2;
      ctxCam.beginPath();
      ctxCam.moveTo(0, scanLineY);
      ctxCam.lineTo(cameraCanvas.width, scanLineY);
      ctxCam.stroke();
      requestAnimationFrame(drawCameraOverlay);
    }

    autoSetBtn.addEventListener("click", () => {
      if (!cameraRunning) return;
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = camera.videoWidth;
      tempCanvas.height = camera.videoHeight;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(camera, 0, 0);
      const frame = tempCtx.getImageData(0, 0, camera.videoWidth, camera.videoHeight).data;
      let maxSum = -1;
      let bestY = 0;
      for (let y = 0; y < camera.videoHeight; y++) {
        let sum = 0;
        for (let x = 0; x < camera.videoWidth; x++) {
          const i = (y * camera.videoWidth + x) * 4;
          sum += frame[i] + frame[i + 1] + frame[i + 2];
        }
        if (sum > maxSum) {
          maxSum = sum;
          bestY = y;
        }
      }
      scanLineY = bestY;
      lineYInput.value = bestY;
      if (currentName) startGenerating(); // random ใหม่ทันที
    });

    lineYInput.addEventListener("change", () => {
      let val = parseInt(lineYInput.value);
      if (isNaN(val) || val < 0) val = 0;
      if (val > cameraCanvas.height - 1) val = cameraCanvas.height - 1;
      scanLineY = val;
      lineYInput.value = val;
      if (currentName) startGenerating(); // random ใหม่ทันที
    });

    cameraCanvas.addEventListener("click", (e) => {
      if (!cameraRunning) return;
      const rect = cameraCanvas.getBoundingClientRect();
      let y = Math.round(e.clientY - rect.top);
      if (y < 0) y = 0;
      if (y > cameraCanvas.height - 1) y = cameraCanvas.height - 1;
      scanLineY = y;
      lineYInput.value = y;
      if (currentName) startGenerating(); // random ใหม่ทันที
    });
  </script>

  <script>
    const toggleBtn = document.getElementById('menuToggle');
    const dropdownMenu = document.getElementById('dropdownMenu');
    toggleBtn.addEventListener('click', () => {
      dropdownMenu.classList.toggle('show-menu');
    });
    document.addEventListener('click', (event) => {
      if (!toggleBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
        dropdownMenu.classList.remove('show-menu');
      }
    });
  </script>
</body>
</html>
