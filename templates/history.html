<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="history.css" />
  <title>CLARA_WEB</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.2/firebase-database.js"></script>

  <script>
    var firebaseConfig = {
        apiKey: "AIzaSyD5QNZ34fy2EH3wxqQY38Ny_mH93dIHptQ",
        authDomain: "clara-454e4.firebaseapp.com",
        databaseURL: "https://clara-454e4-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "clara-454e4",
        storageBucket: "clara-454e4.appspot.com",
        messagingSenderId: "643727783847",
        appId: "1:643727783847:web:f227136002e6d9af2fe882",
        measurementId: "G-J14TTDQVTH"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const historyContainer = document.getElementById("history-container");
      const dbRef = firebase.database().ref();

      dbRef.once('value').then(snapshot => {
        const patientsData = [];

        snapshot.forEach(childSnapshot => {
          const patientName = childSnapshot.key;

          // ข้าม folder "graphs"
          if (patientName === "graphs" || patientName === "screen") return;

          const prediction = childSnapshot.val().prediction || {};
          const date = prediction.date || "N/A";
          const stage = prediction.label || "N/A";

          patientsData.push({
            patientName,
            date,
            stage
          });
        });

        // เรียงข้อมูลตามวันที่
        patientsData.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);

          if (dateA > dateB) return -1;
          if (dateA < dateB) return 1;
          return a.patientName.localeCompare(b.patientName);
        });

        let lastDate = null;

        patientsData.forEach(patient => {
          const { patientName, date, stage } = patient;

          if (date !== lastDate) {
            const divider = document.createElement("div");
            divider.className = "date-divider";
            divider.innerHTML = `<span>${date}</span>`;
            historyContainer.appendChild(divider);
            lastDate = date;
          }

          const box = document.createElement("div");
          let stageClass = "";

          if (stage === "Stage 0" || stage === "Healthy") {
            stageClass = "stage0";
          } else if (stage === "Stage1" || stage === "Stage 1") {
            stageClass = "stage1";
          } else if (stage === "Stage2" || stage === "Stage 2") {
            stageClass = "stage2";
          } else {
            stageClass = "null";
          }

          box.className = `text-box ${stageClass}`;
          box.innerHTML = `
            <h1>${patientName}</h1>
            <p><strong>Result:</strong> ${stage}</p>
            <p><strong>Date:</strong> ${date}</p>
            <button class="btn-small download-btn" data-name="${patientName}">Download PDF</button>
          `;

          historyContainer.appendChild(box);
        });

        // Attach event to all Download buttons
        document.querySelectorAll('.download-btn').forEach(button => {
          button.addEventListener('click', async function() {
            const patientName = this.getAttribute('data-name');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const patientRef = firebase.database().ref(patientName);

            try {
              const snapshot = await patientRef.once('value');
              const patientData = snapshot.val();

              if (patientData) {
                const prediction = patientData.prediction || {};
                const chems = Object.values(patientData).filter(item => item.name && item.value !== undefined);

                let y = 10;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text(`Patient: ${patientName}`, 10, y);
                y += 10;

                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                doc.text(`Stage: ${prediction.label || "N/A"}`, 10, y);
                y += 6;
                doc.text(`Date: ${prediction.date || "N/A"}`, 10, y);
                y += 6;

                chems.forEach(chem => {
                  doc.text(`- ${chem.name}: ${chem.value}`, 10, y);
                  y += 6;
                });

                doc.save(`${patientName}_report.pdf`);
              }
            } catch (error) {
              console.error("Error creating individual PDF:", error);
            }
          });
        });

      }).catch(error => {
        console.error("Error fetching patient data:", error);
      });

      // Download All button
      document.getElementById("download-pdf-btn").addEventListener("click", async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const dbRef = firebase.database().ref();

        try {
          const snapshot = await dbRef.once('value');
          const data = snapshot.val();

          let y = 10;
          const marginBottom = 20;
          doc.setFont("helvetica", "bold");
          doc.setFontSize(16);
          doc.text("CLARA Patient Report", 10, y);
          y += 10;

          doc.setFont("helvetica", "normal");
          doc.setFontSize(12);

          Object.keys(data).forEach((patientName) => {
            // ข้าม folder "graphs"
            if (patientName === "graphs" || patientName === "screen") return;

            const patient = data[patientName];
            const prediction = patient.prediction || {};
            const chems = Object.values(patient).filter(item => item.name && item.value !== undefined);

            doc.text(`Patient: ${patientName}`, 10, y); y += 6;
            doc.text(`Stage: ${prediction.label || "N/A"}`, 10, y); y += 6;
            doc.text(`Date: ${prediction.date || "N/A"}`, 10, y); y += 6;

            chems.forEach(chem => {
              doc.text(`- ${chem.name}: ${chem.value}`, 10, y);
              y += 6;
              if (y > 280 - marginBottom) {
                doc.addPage();
                y = 10;
              }
            });

            y += 10;
            if (y > 280 - marginBottom) {
              doc.addPage();
              y = 10;
            }
          });

          doc.save("clara_patient_data.pdf");

        } catch (error) {
          console.error("Error creating PDF:", error);
        }
      });

    });
  </script>
</head>

<body>
  <nav class="nav">
    <a href="http://127.0.0.1:5000/templates/home.html">
        <div class="navlogo">
        <p>CLARA</p>
        </div>
    </a>
    <div class="nav-menu">
      <ul>
        <li><a href="http://127.0.0.1:5000/templates/home.html" class="link">Home</a></li>
        <li><a href="http://127.0.0.1:5050/" class="link">Screen</a></li>
        <li><a href="http://127.0.0.1:5000/templates/eform.html" class="link">Form</a></li>
        <li><a href="#" class="link active">History</a></li>
        <li><a href="http://127.0.0.1:5000/templates/chat.html" class="link">ChatBot</a></li>
      </ul>
    </div>
    <a href="http://127.0.0.1:5000/templates/!SignIn.html" class="signin-link">
      <div class="sn">
        <div class="snb">
          <i class='bx bxs-user'></i>
          <h3>CLARA</h3>
        </div>
      </div>
    </a>
    <!-- เพิ่มปุ่มเมนูด้านขวา -->
    <div class="dropdown-container">
      <button id="menuToggle" class="menu-btn"><i class='bx bx-menu'></i></button>
      <div id="dropdownMenu" class="dropdown-menu">
        <a href="http://127.0.0.1:5000/templates/tele.html">TeleMed</a>
        <a href="http://127.0.0.1:5000/templates/spec.html">Spectro</a>
        <a href="http://127.0.0.1:5000/templates/info.html">Info</a>
      </div>
    </div>
  </nav>

  <div id="fixed-download-button">
    <button id="download-pdf-btn" class="btn-screen">
      <p><img src="https://i.ibb.co/r2n3198y/download-5.png" alt="Download" width="22px"/></p>
      &nbsp;&nbsp;&nbsp;&nbsp;
      <h3>Download all as PDF</h3> 
    </button>
  </div>

  <div class="main-section">
    <div id="history-container" class="box-wrapper"></div>
  </div>
  <script>
    const toggleBtn = document.getElementById('menuToggle');
    const dropdownMenu = document.getElementById('dropdownMenu');

    toggleBtn.addEventListener('click', () => {
      dropdownMenu.classList.toggle('show-menu');
    });

    document.addEventListener('click', (event) => {
      if (!toggleBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
        dropdownMenu.classList.remove('show-menu');
      }
    });
  </script>
</body>  
</html>
